<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Checkout â€” NareshKart</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { margin:0; font-family:Arial; background:#f5f5f5; }

nav {
  background:#1a1a2e;
  color:#fff;
  padding:16px 32px;
  display:flex;
  justify-content:space-between;
}

nav a { color:#fff; text-decoration:none; margin-left:14px; }

.container {
  padding:32px;
  max-width:600px;
  margin:auto;
}

.card {
  background:#fff;
  padding:24px;
  border-radius:8px;
}

input {
  width:100%;
  padding:10px;
  margin-bottom:12px;
  border-radius:4px;
  border:1px solid #ccc;
}

button {
  padding:12px;
  background:#e94560;
  color:#fff;
  border:none;
  border-radius:6px;
  cursor:pointer;
  width:100%;
}
</style>
</head>
<body>

<nav>
  <strong>Naresh<span style="color:#e94560">Kart</span></strong>
  <div>
    <a href="cart.html">Back to Cart</a>
    <a href="#" onclick="logout()">Logout</a>
  </div>
</nav>

<div class="container">
  <div class="card">
    <h2>Checkout</h2>

    <label>Detected Location</label>
    <input type="text" id="location" placeholder="Detecting..." />

    <button onclick="placeOrder()">Place Order</button>
  </div>
</div>

<script>
const API = "/api";
const token = localStorage.getItem("nk_token");
if (!token) location.href="login.html";

const headers = {
  "Content-Type":"application/json",
  "Authorization":"Bearer "+token
};

// REAL LOCATION DETECTION
navigator.geolocation.getCurrentPosition(async position => {
  const lat = position.coords.latitude;
  const lon = position.coords.longitude;

  // Reverse geocode using open API
  const res = await fetch(
    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`
  );
  const data = await res.json();

  document.getElementById("location").value =
    data.address.city || data.address.town || data.address.state;
});

async function placeOrder() {
  const location = document.getElementById("location").value;

  if (!location) {
    alert("Location required");
    return;
  }

  const buyNow = localStorage.getItem("buy_now");

  const body = buyNow
    ? { location, source:"direct", product_id:buyNow }
    : { location, source:"cart" };

  const res = await fetch(API+"/orders",{
    method:"POST",
    headers:headers,
    body:JSON.stringify(body)
  });

  const data = await res.json();

  if (!res.ok) {
    alert(data.message || "Order failed");
    return;
  }

  localStorage.removeItem("buy_now");
  localStorage.setItem("last_order", data.order_id);

  location.href="payment.html";
}

function logout(){
  localStorage.clear();
  location.href="login.html";
}
</script>

</body>
</html>
