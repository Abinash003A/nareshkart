<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Checkout ‚Äî NareshKart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Arial,sans-serif;background:#f5f5f5}
    nav{background:#1a1a2e;color:#fff;padding:16px 32px;display:flex;justify-content:space-between;align-items:center}
    nav a{color:#fff;text-decoration:none;margin-left:16px;font-weight:600;font-size:14px}
    .container{max-width:560px;margin:40px auto;padding:0 24px}
    .card{background:#fff;padding:28px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
    h2{color:#1a1a2e;margin-bottom:20px}
    label{display:block;font-size:13px;color:#555;margin-bottom:4px;font-weight:600}
    input{width:100%;padding:12px;border-radius:6px;border:1px solid #ddd;font-size:15px;outline:none;margin-bottom:16px}
    input:focus{border-color:#e94560}
    .detect-btn{background:none;border:none;color:#0f3460;font-size:13px;cursor:pointer;padding:0;margin-bottom:16px;text-decoration:underline}
    .place-btn{width:100%;padding:14px;background:#e94560;color:#fff;border:none;border-radius:6px;font-weight:700;font-size:15px;cursor:pointer}
    .place-btn:disabled{background:#ccc;cursor:not-allowed}
    .msg{padding:10px;border-radius:4px;margin-bottom:12px;font-size:13px;display:none}
    .msg.error{background:#fff0f0;color:#c0392b;border:1px solid #f5c6cb;}
  </style>
</head>
<body>
<nav>
  <div><strong>Naresh<span style="color:#e94560">Kart</span></strong></div>
  <div>
    <a href="cart.html">‚Üê Back to Cart</a>
    <a href="#" onclick="logout()">Logout</a>
  </div>
</nav>

<div class="container">
  <div class="card">
    <h2>üì¶ Checkout</h2>
    <div class="msg error" id="msg"></div>

    <label>Delivery Location</label>
    <input type="text" id="location" placeholder="Enter your city / area..."/>
    <button class="detect-btn" onclick="detectLocation()">üìç Auto-detect my location</button>

    <button class="place-btn" id="place-btn" onclick="placeOrder()">Place Order</button>
  </div>
</div>

<script>
const API="/api";
const token=localStorage.getItem("nk_token");
if(!token)window.location.href="login.html";
const headers={"Content-Type":"application/json","Authorization":"Bearer "+token};

function showError(msg){
  const m=document.getElementById("msg");
  m.textContent=msg; m.style.display="block";
}

function detectLocation(){
  if(!navigator.geolocation){showError("Geolocation not supported by your browser.");return;}
  document.getElementById("location").placeholder="Detecting...";
  navigator.geolocation.getCurrentPosition(async pos=>{
    const {latitude:lat,longitude:lon}=pos.coords;
    try{
      const res=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
      const data=await res.json();
      const loc=data.address.city||data.address.town||data.address.county||data.address.state||"Unknown";
      document.getElementById("location").value=loc;
    }catch{
      document.getElementById("location").placeholder="Could not detect. Enter manually.";
    }
  },()=>{document.getElementById("location").placeholder="Permission denied. Enter manually.";});
}

async function placeOrder(){
  const location=document.getElementById("location").value.trim();
  if(!location){showError("Please enter a delivery location.");return;}

  const btn=document.getElementById("place-btn");
  btn.disabled=true; btn.textContent="Placing order...";
  document.getElementById("msg").style.display="none";

  const buyNow=localStorage.getItem("buy_now");
  const body=buyNow
    ?{location,source:"direct",product_id:parseInt(buyNow)}
    :{location,source:"cart"};

  try{
    const res=await fetch(API+"/orders",{method:"POST",headers,body:JSON.stringify(body)});
    const data=await res.json();

    if(!res.ok){
      btn.disabled=false; btn.textContent="Place Order";
      showError(data.message||"Order failed. Try again.");
      return;
    }

    localStorage.removeItem("buy_now");
    localStorage.setItem("last_order",data.order_id);

    // FIX: Use window.location.href (not local var 'location' which was overwritten)
    window.location.href="payment.html";

  }catch{
    btn.disabled=false; btn.textContent="Place Order";
    showError("Server error. Please try again.");
  }
}

function logout(){localStorage.clear();window.location.href="login.html";}
</script>
</body>
</html>
